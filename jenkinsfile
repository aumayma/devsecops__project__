pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/aumayma/devsecops__project__.git'
            }
        }

stage('Run Gitleaks') {
            steps {
                script {
                    def result = sh(script: 'gitleaks detect --source . --verbose --redact', returnStatus: true)
                    if (result != 0) {
                        error("❌ Des secrets ont été détectés ! Corrige-les avant de pousser le code.")
                    }
                }
            }
        }
              

        stage('Notifier par E-mail') {
            steps {
                script {
                    def secretsFound = sh(script: 'gitleaks detect --source . --verbose --redact', returnStatus: true)
                    
                    def subject = secretsFound == 0 ? '✅ Aucun secret détecté' : '🚨 Secret détecté dans le code !'
                    def body = secretsFound == 0 ? 
                        'Bonne nouvelle ! Aucun secret n’a été détecté. Tu peux continuer ton déploiement. 🚀' : 
                        'Attention ! Des secrets ont été trouvés dans le code. Corrige-les avant de pousser le code. ❌'

                    emailext subject: subject,
                             body: body,
                             to: 'selmioumayma89@gmail.com',
                             from: 'selmioumayma89@gmail.com',
                             mimeType: 'text/html'
                    
                    if (secretsFound != 0) {
                        error('Secrets détectés, arrêt du pipeline.')
                    }
                }
            }
        }
stage('Build Docker Image') {
    steps {
        sh "docker build -t monapp:latest ."
    }
}

}
}
