pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/aumayma/devsecops__project__.git'
            }
        }

stage('Run Gitleaks') {
            steps {
                script {
                    def result = sh(script: 'gitleaks detect --source . --verbose --redact', returnStatus: true)
                    if (result != 0) {
                        error("âŒ Des secrets ont Ã©tÃ© dÃ©tectÃ©s ! Corrige-les avant de pousser le code.")
                    }
                }
            }
        }
              

        stage('Notifier par E-mail') {
            steps {
                script {
                    def secretsFound = sh(script: 'gitleaks detect --source . --verbose --redact', returnStatus: true)
                    
                    def subject = secretsFound == 0 ? 'âœ… Aucun secret dÃ©tectÃ©' : 'ğŸš¨ Secret dÃ©tectÃ© dans le code !'
                    def body = secretsFound == 0 ? 
                        'Bonne nouvelle ! Aucun secret nâ€™a Ã©tÃ© dÃ©tectÃ©. Tu peux continuer ton dÃ©ploiement. ğŸš€' : 
                        'Attention ! Des secrets ont Ã©tÃ© trouvÃ©s dans le code. Corrige-les avant de pousser le code. âŒ'

                    emailext subject: subject,
                             body: body,
                             to: 'selmioumayma89@gmail.com',
                             from: 'selmioumayma89@gmail.com',
                             mimeType: 'text/html'
                    
                    if (secretsFound != 0) {
                        error('Secrets dÃ©tectÃ©s, arrÃªt du pipeline.')
                    }
                }
            }
        }
stage('Build Docker Image') {
    steps {
        sh "docker build -t monapp:latest ."
    }
}

}
}
